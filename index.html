<!DOCTYPE html>
<!-- BRANDON SERRAO, CONTRIBUTING TO INTERNSHIP FOR CONSULTANTS NEXT DOOR & CARBON ZERO INSTITUTE OF TRINIDAD AND TOBAGO -->
<html>

	<head>
		<title>Map Local Copy</title>
		<!-- this is what an HTML comment looks like -->
		 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
			integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
			crossorigin=""/>

		<!-- Make sure you put this AFTER Leaflet's CSS -->
		<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
			integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
			crossorigin="">
		</script>

		<link rel="stylesheet" href="style.css"/>

		<!--sidebar files-->
		<script src="./plugins/sidebar/leaflet-sidebar.js">
		</script>
		<link rel="stylesheet" href="./plugins/sidebar/leaflet-sidebar.css"/>

	</head>


	<body>
		 <div id="mapid"></div>
		 <script>
		 //SETUP MAP OBJECT
			let mapOptions = {
				center: [10.69, -61.1],
				zoom: 9,
			};
			const myMap = L.map("mapid", mapOptions);
			const Maptiles_A = L.tileLayer(
				'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
				{
				maxZoom: 19,
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			});

			Maptiles_A.addTo(myMap).setOpacity(0.5);
			//END - SETUP MAP OBJECT

			//FORMATTING DATA LAYER
			let marker_icon = L.icon({
				iconUrl: "marker-icon.png",
				iconAnchor: [12, 20],
			})
			let selected_icon = L.icon({
				iconUrl: "highlighted-icon.png",
				iconAnchor: [12, 20],
				popupAnchor: [0, -10]
			});

			let treeLayer = L.geoJSON(null,
									{
										onEachFeature:
										function (feature, layer) {
											f = feature.properties;
										//layer.bindPopup(`Tree Type:<i>${feature.properties.type}<i>`)
										layer.bindPopup(`
											<div class="tree-type">#${f.NUMBER}: ${f.TYPE}</div>
											<div class="timestamp">${f.PHOTO_TIMESTAMP}</div>
											<img class="photo" src="./photos/placeholder.png" alt="Photo of tree">
											<div class="offset">Est.Offset: ${f.CARBONOFF_EST}</div>
											<div class="beneficiary">Beneficiary: ${f.BENEFICIARY}</div>
											<div class="planter">Planter: ${f.PLANTER}</div>
											<div class="risk-level">Risk: ${f.RISKLEVEL}</div>
											`)
										},

										pointToLayer: function (feature, latlng) {
											let marker = L.marker(latlng, {
												title: "click to inspect", //adds tooltip
												riseOnHover: true, //brings marker on top of others on hover
												icon: marker_icon,
											});

											return marker;
										},
									}
									);

			treeLayer.addTo(myMap);
			//END - FORMATTING DATA LAYER

			//SIDEBAR IMPLEMENTATION
			let sidebar = L.control.sidebar({
				autopan: false,
				closeButton: true,
				container: "sidebar",
				position: "right"
			}).addTo(myMap);

			//let info = "<h1>Test content</h1>"; //TODO add static content for splash-screen-sidebar
			//TODO fix closebutton icon
			let info = `<h1>Tree Catalog - The Carbon Capture Institute of Trinidad & Tobago</h1>
									<h2>Purpose:</h2>
									<h2>Contributors:</h2>`;
			let panelContent = {
			    id: 'info',
			    tab: '<img class ="sidebar-tab-icon" src="./logos/logo_color.png">', //TODO get better icon
			    pane: info,
			    title: 'Information',
			    position: 'top'
			};
			sidebar.addPanel(panelContent);
			sidebar.open("info");

			sidebar.addPanel({
			    id: 'ghlink',
			    tab: '<img class ="sidebar-tab-icon" src="./logos/github_logo.png">', //TODO get better icon
			    button: 'https://github.com/brandonserrao/CND_CZITT_TreesMap',
					position: "bottom"
			});

				//close on map click behaviour
			myMap.on("click", function () {sidebar.close()});

			//END - SIDEBAR IMPLEMENTATION


			//HIGHLIGHTING FUNCTIONALITY
			let selected = null;
			treeLayer.on("click", function(event) { //binding onclick event listener to all members of the layer in one go
				let fade = 0.2;
				if (selected == null) {
					console.log("first selection, increasing transparency")
					treeLayer.invoke("setOpacity", fade);
				}
				else {
					selected.setOpacity(fade);
					selected.setIcon(marker_icon);
					console.log("switching selection");
				}
				selected = event.layer;
				console.log(selected);
				selected.setOpacity(1.0);
				selected.setIcon(selected_icon);

			})
			//to reset opacity of markers by clicking on the map itself
			myMap.on("click", function (event) {
				if (selected) {
					console.log("clearing selection, resetting opacity")
					selected.setIcon(marker_icon);
					selected = null;
					treeLayer.invoke("setOpacity", 1.0);
				}
			})
			//END - HIGHLIGHTING FUNCTIONALITY

			//MARKER DOUBLE CLICK FUNCTIONALITY
			//treeLayer.on("dblclick", )
			//END - MARKER DOUBLE CLICK FUNCTIONALITY

			//FETCHING THE DATA
			let treeData; //creating an empty container for treedata

			fetch("./treesdata_wgs84.geojson")
				.then(response => {
				return response.json();
			})
			.then(data => {
				return treeData = data;
				})
			.then(data => treeLayer.addData(data));
			//END - FETCHING THE DATA
		</script>
	</body>

</html>
