<!DOCTYPE html>
<!-- BRANDON SERRAO, CONTRIBUTING TO INTERNSHIP FOR CONSULTANTS NEXT DOOR & CARBON ZERO INSTITUTE OF TRINIDAD AND TOBAGO -->
<html>

	<head>
		<title>Map Local Copy</title>
		<!-- this is what an HTML comment looks like -->
		 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
			integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
			crossorigin=""/>

		<!-- Make sure you put this AFTER Leaflet's CSS -->
		<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
			integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
			crossorigin="">
		</script>

		<link rel="stylesheet" href="style.css"/>


		<!--sidebar files-->
		<script src="./plugins/sidebar/leaflet-sidebar.js">
		</script>
		<link rel="stylesheet" href="./plugins/sidebar/leaflet-sidebar.css"/>

	</head>


	<body>
		 <div id="mapid"></div>
		 <script>
		 //SETUP MAP OBJECT
			let mapOptions = {
				center: [10.69, -61.1],
				zoom: 9,
			};
			const myMap = L.map("mapid", mapOptions);
			const Maptiles_A = L.tileLayer(
				'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
				{
				maxZoom: 19,
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			});

			Maptiles_A.addTo(myMap).setOpacity(0.5);
			//END - SETUP MAP OBJECT

			//FORMATTING DATA LAYER
			let marker_icon = L.icon({
				iconUrl: "marker-icon.png",
				iconAnchor: [12, 20],
			})
			let selected_icon = L.icon({
				iconUrl: "highlighted-icon.png",
				iconAnchor: [12, 20],
				popupAnchor: [0, -10]
			});

			//EXPERIMENTAL FUNCTIONS
			function onTreeFeature (feature, layer) {
										f = feature.properties;
										//layer.bindPopup(`Tree Type:<i>${feature.properties.type}<i>`)
										layer.bindPopup(`
											<div class="tree-type">#${f.NUMBER}: ${f.TYPE}</div>
											<div class="timestamp">${f.PHOTO_TIMESTAMP}</div>
											<img class="photo" src="./photos/placeholder.png" alt="Photo of tree">
											<div class="offset">Est.Offset: ${f.CARBONOFF_EST}</div>
											<div class="beneficiary">Beneficiary: ${f.BENEFICIARY}</div>
											<div class="planter">Planter: ${f.PLANTER}</div>
											`)
										};
			function treeToLayer(feature, latlng) {
											let marker = L.marker(latlng, {
												title: "click to inspect", //adds tooltip
												riseOnHover: true, //brings marker on top of others on hover
												icon: marker_icon,
											});

											return marker;
										}
			//END - EXPERIMENTAL FUNCTIONS

/*			//obsoleted
			let treeLayer = L.geoJSON(null,
									{
										onEachFeature:
										function (feature, layer) {
											f = feature.properties;
										//layer.bindPopup(`Tree Type:<i>${feature.properties.type}<i>`)
										layer.bindPopup(`
											<div class="tree-type">#${f.NUMBER}: ${f.TYPE}</div>
											<div class="timestamp">${f.PHOTO_TIMESTAMP}</div>
											<img class="photo" src="./photos/placeholder.png" alt="Photo of tree">
											<div class="offset">Est.Offset: ${f.CARBONOFF_EST}</div>
											<div class="beneficiary">Beneficiary: ${f.BENEFICIARY}</div>
											<div class="planter">Planter: ${f.PLANTER}</div>
											`)
										},

										pointToLayer: function (feature, latlng) {
											let marker = L.marker(latlng, {
												title: "click to inspect", //adds tooltip
												riseOnHover: true, //brings marker on top of others on hover
												icon: marker_icon,
											});

											return marker;
										},
									}
									);

			treeLayer.addTo(myMap);
			//end-obsoleted
*/
			//END - FORMATTING DATA LAYER


			//SIDEBAR IMPLEMENTATION
			let sidebar = L.control.sidebar({
				autopan: false,
				closeButton: true,
				container: "sidebar",
				position: "right"
			}).addTo(myMap);



			//TODO fix closebutton icon
			let info=`<h1>Tree Catalog - The Carbon Zero Institute of Trinidad and Tobago</h1>
					<h2>Purpose:</h2>
					<p> Carbon emissions from fossil fuels, the inustrial sector and land use is the largest source of global Greenhouse Gas (GHG) emissions.
					We must act now and do our part to combat the exacerbated effects of climate change.
					The CZITT 1000 trees challenge initiative partners with schools, clubs and corporations to plant and record trees which are then geotagged.
					Our goal is to establish a carbon offset registry in which its efforts are driven towards reducing carbon emissions via carbon sequestration as a proven climate change mitigation strategy.</p>
					<h2>Contributors:</h2>
					<p>Ryan Seemungal, Data Visualization Specialist</p>
					<p>Brandon Serrao, Cartography Instructor</p>
					<p>Sweelan Renaud, Program Assistant at Advisors Next Door</p>
					<p>Aashrita Mohess, Intern at Advisors Next Door </p>
					<h4> Contact:</4>
					<p> Contact us at <a href="mailto:advisorsnextdoor@gmail.com"target="_blank">advisorsnextdoor@gmail.com</a> for more information</p>

					<p>Visit <a href= "https://czitt-ed.org/"target="_blank">Caribbean E-Learning by the Carbon Zero Institute of Trinidad and Tobago</a> to learn more about this project and how you can get involved</p>

					<p> Date Last Updated: 16th July 2021</p>
					`;
			let panelContent = {
			    id: 'info',
			    tab: '<img class ="sidebar-tab-icon" src="./logos/logo_color.png">', //TODO get better icon
			    pane: info,
			    title: 'Information',
			    position: 'top'
			};
			sidebar.addPanel(panelContent);
			sidebar.open("info");

			sidebar.addPanel({
			    id: 'ghlink',
			    tab: '<img class ="sidebar-tab-icon" src="./logos/github_logo.png">', //TODO get better icon
			    button: 'https://github.com/brandonserrao/CND_CZITT_TreesMap',
					position: "bottom"
			});

				//close on map click behaviour
			myMap.on("click", function () {sidebar.close()});

			//END - SIDEBAR IMPLEMENTATION

			let treesLayerGroup = L.layerGroup().addTo(myMap);
			//HIGHLIGHTING FUNCTIONALITY
			//Broken-as using a single layer group to manage individual geoJSON featuregrouplayers per org
			//selected marker still changes icon(if using a featureGroup instead of layerGroup); invoked fade appears not to work (due to reason raised above)
			//TODO intended fix: ascertain selected _geoJSON layer of beneficiaries_ and apply fading(or interactive:false) to others
			//then further behaviours to add after
			let selected = null;
			treesLayerGroup.on("click", function(event) { //binding onclick event listener to all members of the layer in one go
				let fade = 0.2;
				if (selected == null) {
					console.log("first selection, increasing transparency")
					treesLayerGroup.invoke("setOpacity", fade);
				}
				else {
					selected.setOpacity(fade);
					selected.setIcon(marker_icon);
					console.log("switching selection");
				}
				selected = event.layer;
				console.log(selected);
				selected.setOpacity(1.0);
				selected.setIcon(selected_icon);

			})
			//to reset opacity of markers by clicking on the map itself
			myMap.on("click", function (event) {
				if (selected) {
					console.log("clearing selection, resetting opacity")
					selected.setIcon(marker_icon);
					selected = null;
					treesLayerGroup.invoke("setOpacity", 1.0);
				}
			})
			//END - HIGHLIGHTING FUNCTIONALITY

			//MARKER DOUBLE CLICK FUNCTIONALITY
			//treesLayerGroup.on("dblclick", )
			//END - MARKER DOUBLE CLICK FUNCTIONALITY


//EXP-FETCHING AND SORTING Data

			let beneficiaries = {}; //container to hold the separated data per beneficiary org
			let org_control;

			fetch("./treesdata_wgs84.geojson")
			.then(response => {return response.json();})
			.then(function(json) {
				data = json.features;
				for (let feature of data) {
					console.log(feature);
					let org = feature.properties.BENEFICIARY;

					if (org == null) {org = "none"}
					if (!(org in beneficiaries)) { //if the org is not in the dictionary
						beneficiaries[org] = L.geoJSON(null, { // setup a new entry in the list, its settings, and add the record as well
																									onEachFeature: onTreeFeature,
																									pointToLayer: treeToLayer,
																									});
						treesLayerGroup.addLayer(beneficiaries[org]);
					}
					console.log()
					beneficiaries[org].addData(feature);
				}

				console.log(beneficiaries);
				return beneficiaries
			})
			.then(function(beneficiaries) {
				org_control = L.control.layers(null, beneficiaries).addTo(myMap); //adds toggle control to map
			})


//END EXP-FETCHING AND SORTING DATA

/*			//obsoleted by code to bring in layers per org
			//FETCHING THE DATA
			let treeData; //creating an empty container for treedata

			fetch("./treesdata_wgs84.geojson")
				.then(response => {
				return response.json();
			})
			.then(data => {
				return treeData = data;
				})
			.then(data => treeLayer.addData(data));
			//END - FETCHING THE DATA
*/
		</script>
	</body>

</html>
